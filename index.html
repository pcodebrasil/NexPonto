<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexPonto | Gest√£o Inteligente</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root {
            /* Identidade Visual NexPonto */
            --primary: #FFD700; /* Ouro Taxi - Alta Visibilidade */
            --accent: #ffffff;
            --bg: #000000;
            --surface: #1a1a1a;
            --input-bg: #222;
            --danger: #ff4444;
            --success: #00C851;
            --scheduled: #33b5e5; /* Azul Futuro/Nex */
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--accent);
            margin: 0; height: 100vh; display: flex; flex-direction: column;
        }

        /* LOGOTIPO NEXPONTO */
        .brand-logo {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--primary);
            text-transform: uppercase;
            margin-bottom: 2px;
            font-style: italic; /* D√° sensa√ß√£o de movimento/velocidade */
        }
        .brand-logo span { color: #fff; } /* O "Nex" ou "Ponto" pode ser branco para contraste */
        
        .brand-subtitle {
            font-size: 0.8rem;
            color: #888;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        /* COMPONENTES */
        #app-container { flex: 1; overflow-y: auto; padding: 20px; }
        .screen { display: none; }
        .screen.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from {transform: translateY(20px); opacity:0} to {transform: translateY(0); opacity:1} }

        .btn {
            border: none; padding: 16px; border-radius: 8px;
            font-weight: 700; width: 100%; font-size: 16px;
            margin-bottom: 15px; cursor: pointer; text-transform: uppercase;
            letter-spacing: 1px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { 
            background: var(--primary); color: #000; 
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.15); 
        }
        .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
        .btn-sm { padding: 8px 12px; font-size: 12px; width: auto; margin: 0; }

        .input-field {
            width: 100%; padding: 16px; background: var(--input-bg);
            border: 1px solid #333; border-radius: 8px; color: white;
            box-sizing: border-box; margin-bottom: 15px; font-size: 16px;
        }
        .input-field:focus { outline: none; border-color: var(--primary); background: #2a2a2a; }

        /* CARDS DE CORRIDA */
        .ride-card {
            background: var(--surface); padding: 16px;
            border-radius: 12px; margin-bottom: 12px;
            border-left: 4px solid #333; display: flex;
            justify-content: space-between; align-items: center;
        }
        .ride-card.status-pending { border-left-color: var(--primary); }
        .ride-card.status-scheduled { border-left-color: var(--scheduled); }

        /* LOADING */
        #loading {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 99;
            display: none; flex-direction: column; 
            justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <div style="color: #666; font-size: 0.9rem; letter-spacing: 2px;">NEXPONTO</div>
    </div>

    <div id="app-container">

        <div id="screen-login" class="screen active">
            <div style="text-align: center; margin-top: 15vh; margin-bottom: 50px;">
                <div class="brand-logo">NEX<span>PONTO</span></div>
                <div class="brand-subtitle">Gest√£o Inteligente</div>
            </div>
            
            <input id="login-email" class="input-field" type="email" placeholder="ID do Estabelecimento">
            <input id="login-pass" class="input-field" type="password" placeholder="Senha de Acesso">
            <button class="btn btn-primary" onclick="app.login()">Entrar no Sistema</button>
            
            <p style="text-align: center; color: #444; font-size: 11px; margin-top: 60px; text-transform: uppercase;">
                Powered by Pkacci Architecture ¬© 2026
            </p>
        </div>

        <div id="screen-locked" class="screen" style="text-align: center; padding-top: 30vh;">
            <h1 style="color: var(--danger); font-size: 3rem; margin-bottom: 10px;">üõë</h1>
            <h2 style="color: var(--danger); text-transform: uppercase;">Acesso Suspenso</h2>
            <p style="color: #888; margin-bottom: 30px; line-height: 1.5;">
                A licen√ßa de uso deste ponto expirou.<br>Realize a renova√ß√£o para continuar.
            </p>
            <button class="btn btn-danger" onclick="app.logout()">Voltar ao In√≠cio</button>
        </div>

        <div id="screen-dashboard" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <div class="brand-logo" style="font-size: 1.4rem;">NEX<span>PONTO</span></div>
                <button class="btn btn-danger btn-sm" onclick="app.logout()">SAIR</button>
            </div>

            <div style="background: #111; border: 1px solid #333; padding: 20px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <h3 style="margin: 0 0 15px 0; color: var(--primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">
                    ‚ö° Novo Pedido
                </h3>
                
                <input id="new-name" class="input-field" placeholder="Nome do Passageiro">
                <input id="new-dest" class="input-field" placeholder="Destino / Endere√ßo">
                
                <div style="display: flex; gap: 10px;">
                    <input id="new-val" type="number" class="input-field" placeholder="R$ Valor">
                    <input id="new-time" type="datetime-local" class="input-field" style="font-size: 13px;">
                </div>
                
                <button class="btn btn-primary" style="margin-bottom: 0;" onclick="app.createRide()">LAN√áAR CORRIDA</button>
            </div>

            <h3 style="color: #666; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px;">
                Fila de Atendimento
            </h3>
            <div id="rides-list">
                </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, orderBy, onSnapshot, updateDoc, Timestamp } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configura√ß√£o mantida do seu projeto
        const firebaseConfig = {
            apiKey: "AIzaSyBylSqY9gUtjygPD6X20LQOH0kVg-NRczA",
            authDomain: "agenda-facil-b5542.firebaseapp.com",
            projectId: "agenda-facil-b5542",
            storageBucket: "agenda-facil-b5542.firebasestorage.app",
            messagingSenderId: "862816221186",
            appId: "1:862816221186:web:e4339102a644f8abf60f1b"
        };

        const appInit = initializeApp(firebaseConfig);
        const auth = getAuth(appInit);
        const db = getFirestore(appInit);
        let currentUser = null;

        const App = {
            login: async () => {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                if(!email || !pass) return alert("Por favor, preencha todos os campos.");
                
                try {
                    document.getElementById('loading').style.display = 'flex';
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch (e) { 
                    alert("Acesso negado: " + e.message); 
                    document.getElementById('loading').style.display = 'none'; 
                }
            },

            logout: () => signOut(auth),

            createRide: async () => {
                const name = document.getElementById('new-name').value;
                const dest = document.getElementById('new-dest').value;
                const val = document.getElementById('new-val').value;
                const dateInput = document.getElementById('new-time').value;

                if(!name || !dest || !val) return alert("Preencha os dados da corrida.");

                try {
                    let status = "pending";
                    let scheduledTimestamp = Timestamp.now(); 

                    if(dateInput) {
                        status = "scheduled";
                        scheduledTimestamp = Timestamp.fromDate(new Date(dateInput));
                    }

                    await addDoc(collection(db, "rides"), {
                        establishmentId: currentUser.uid,
                        passengerName: name,
                        destination: dest,
                        value: parseFloat(val),
                        status: status,
                        createdAt: Timestamp.now(),
                        scheduledFor: scheduledTimestamp
                    });

                    // Limpa formul√°rio
                    document.getElementById('new-name').value = "";
                    document.getElementById('new-dest').value = "";
                    document.getElementById('new-val').value = "";
                    document.getElementById('new-time').value = "";
                    
                } catch (e) { console.error(e); alert("Erro ao criar pedido."); }
            },

            cancelRide: async (rideId) => {
                if(confirm("Cancelar este pedido?")) {
                    await updateDoc(doc(db, "rides", rideId), { status: "cancelled" });
                }
            },

            startRideListener: () => {
                const q = query(
                    collection(db, "rides"),
                    where("establishmentId", "==", currentUser.uid),
                    where("status", "in", ["pending", "scheduled"]),
                    orderBy("scheduledFor", "asc")
                );

                onSnapshot(q, (snapshot) => {
                    const listEl = document.getElementById('rides-list');
                    listEl.innerHTML = "";

                    if(snapshot.empty) {
                        listEl.innerHTML = '<div style="text-align:center; color:#444; margin-top:40px; font-size:0.9rem;">Nenhum pedido ativo no momento.</div>';
                        return;
                    }

                    snapshot.forEach(docSnap => {
                        const r = docSnap.data();
                        const isScheduled = r.status === 'scheduled';
                        const dateObj = r.scheduledFor.toDate();
                        
                        // Formata√ß√£o da Hora
                        const timeString = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const dateString = dateObj.toLocaleDateString();

                        const html = `
                            <div class="ride-card status-${r.status}">
                                <div>
                                    <div style="font-weight:bold; font-size:1.1rem; color:white; margin-bottom:4px;">${r.passengerName}</div>
                                    <div style="color:#aaa; font-size:0.9rem; margin-bottom:6px;">üìç ${r.destination}</div>
                                    <div style="color:${isScheduled ? 'var(--scheduled)' : 'var(--primary)'}; font-size:0.8rem; font-weight:bold; text-transform:uppercase;">
                                        ${isScheduled ? 'üìÖ ' + dateString + ' √†s ' + timeString : '‚ö° IMEDIATO'}
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-weight:bold; font-size:1.3rem; color:var(--success);">R$ ${r.value}</div>
                                    <button onclick="app.cancelRide('${docSnap.id}')" style="background:none; border:1px solid #333; border-radius:4px; color:#666; font-size:0.7rem; margin-top:8px; padding:6px 10px;">CANCELAR</button>
                                </div>
                            </div>
                        `;
                        listEl.innerHTML += html;
                    });
                });
            },

            checkLicense: async (user) => {
                currentUser = user;
                // Busca de Licen√ßa (SaaS)
                const docRef = doc(db, "establishments", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().active) {
                    document.querySelector('#screen-login').classList.remove('active');
                    document.querySelector('#screen-dashboard').classList.add('active');
                    document.getElementById('loading').style.display = 'none';
                    App.startRideListener();
                } else {
                    document.querySelector('#screen-login').classList.remove('active');
                    document.querySelector('#screen-locked').classList.add('active');
                    document.getElementById('loading').style.display = 'none';
                }
            }
        };

        // Inicializa√ß√£o
        onAuthStateChanged(auth, (user) => {
            if (user) App.checkLicense(user);
            else {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('#screen-dashboard').classList.remove('active');
                document.querySelector('#screen-locked').classList.remove('active');
                document.querySelector('#screen-login').classList.add('active');
            }
        });

        window.app = App;
    </script>
</body>
</html>
